# Microsoft Azure Container Networking

## Azure CNI Plugins
(https://github.com/containernetworking/cni/blob/master/SPEC.md)

`azure-vnet` is a CNI network plugin. It connects containers to an Azure VNET.<br>
`azure-vnet-ipam` is a CNI IPAM plugin that allocates IP addresses from an Azure VNET address space.

The plugins are designed to work together. The IPAM plugin can also be used by 3rd party software to allocate IP addresses from VNET space.

## Build
Plugins of both types are built for `Windows amd64` and `Linux amd64` platforms. Latest plugin binaries are availble in `release`.

Plugins can also be built directly from the source code in this repository.

```bash
make azure-vnet
make azure-vnet-ipam
make azure-cni-plugins
```

The first two commands build that individual plugin, whereas the third one builds both and generates a tarball. The binaries are placed in the `output` directory.

## Network Configuration
Network configuration for CNI plugins is described in JSON form. The default location for configuration files is `/etc/cni/net.d` for Linux and `<TODO>` for Windows.

```json
{
  "cniVersion": "0.2.0",
  "name": "azure",
  "type": "azure-vnet",
  "master": "eth0",
  "bridge": "azure0",
  "ipam": {
    "type": "azure-vnet-ipam",
    "environment": "azure"
  }
}
```

The following fields are well-known and have the following meaning:

Network plugin
* `cniVersion`: Azure plugins currently support versions 0.1.0 and 0.2.0 of the [CNI spec](https://github.com/containernetworking/cni/blob/master/SPEC.md). Support for new versions will be added for each CNI release.
* `name`: Name of the network. This property can be set to any unique value.
* `type`: Name of the network plugin. This property should always be set to `azure-vnet`.
* `master`: Name of the master network interface. The common case is for a container host to have one network interface. For Windows, this would be `"Ethernet"`. For Linux, `"eth0"`. If the host has multiple network interfaces, set this property to the name of the network interface that should forward container traffic.
* `bridge`: Name of the bridge.

IPAM plugin
* `type`: Name of the IPAM plugin. This property should always be set to `azure-vnet-ipam`.
* `environment`: Name of the environment. Valid values are `azure` for [Azure](https://azure.microsoft.com) and `mas` for [Microsoft Azure Stack](https://azure.microsoft.com/en-us/overview/azure-stack/). The default value is `azure`.

You can create multiple network configuration files to connect containers to multiple networks.

Network configuration files are processed in lexical order during container creation, and in the reverse-lexical order during container deletion.

Kubernetes creates a loopback interface automatically, so you don't need a `loopback.conf`.

## Logs
Logs generated by `azure-vnet` plugin are available in `/var/log/azure-vnet.log` on Linux and `(TODO)` on Windows.

Logs generated by `azure-vnet-ipam` plugin are availble in `/var/log/azure-vnet.log` on Linux and `(TODO)` on Windows.
